name: ðŸš€ 20x RDP Mega Batch
on: [workflow_dispatch]

jobs:
  rdp-sessions:
    strategy:
      matrix:
        id: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20]
    runs-on: windows-latest
    timeout-minutes: 350
    outputs:
      ip-${{ matrix.id }}: ${{ steps.rdp.outputs.ip }}
    steps:
    - name: RDP #${{ matrix.id }}
      id: rdp
      run: |
        Set-ItemProperty -Path 'HKLM:SystemCurrentControlSetControlTerminal Server' -Name "fDenyTSConnections" -Value 0
        netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389
        $pass = "RDP2025@#123"
        $secpass = ConvertTo-SecureString $pass -AsPlainText -Force
        $user = "RDP2025"
        if (!(Get-LocalUser $user -ErrorAction SilentlyContinue)) {
          New-LocalUser $user -Password $secpass -AccountNeverExpires
        }
        Add-LocalGroupMember "Administrators" $user
        Add-LocalGroupMember "Remote Desktop Users" $user
        Invoke-WebRequest "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi" -OutFile "$env:TEMP\ts.msi"
        Start-Process msiexec.exe -ArgumentList "/i `"$env:TEMP\ts.msi`" /quiet" -Wait
        $hn = "rdp${{ matrix.id }}-${env:GITHUB_RUN_NUMBER}"
        & "$env:ProgramFilesTailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=$hn
        Start-Sleep 20
        $ip = & "$env:ProgramFilesTailscale\tailscale.exe" ip -4
        echo "ip=$ip" >> $GITHUB_OUTPUT

  summary:
    needs: rdp-sessions
    runs-on: ubuntu-latest
    steps:
    - uses: actions/github-script@v7
      with:
        script: |
          const ips = [
            `${{ needs.rdp-sessions.outputs['ip-1'] }}:3389`,
            `${{ needs.rdp-sessions.outputs['ip-2'] }}:3389`,
            `${{ needs.rdp-sessions.outputs['ip-3'] }}:3389`,
            `${{ needs.rdp-sessions.outputs['ip-4'] }}:3389`,
            `${{ needs.rdp-sessions.outputs['ip-5'] }}:3389`,
            `${{ needs.rdp-sessions.outputs['ip-6'] }}:3389`,
            `${{ needs.rdp-sessions.outputs['ip-7'] }}:3389`,
            `${{ needs.rdp-sessions.outputs['ip-8'] }}:3389`,
            `${{ needs.rdp-sessions.outputs['ip-9'] }}:3389`,
            `${{ needs.rdp-sessions.outputs['ip-10'] }}:3389`,
            `${{ needs.rdp-sessions.outputs['ip-11'] }}:3389`,
            `${{ needs.rdp-sessions.outputs['ip-12'] }}:3389`,
            `${{ needs.rdp-sessions.outputs['ip-13'] }}:3389`,
            `${{ needs.rdp-sessions.outputs['ip-14'] }}:3389`,
            `${{ needs.rdp-sessions.outputs['ip-15'] }}:3389`,
            `${{ needs.rdp-sessions.outputs['ip-16'] }}:3389`,
            `${{ needs.rdp-sessions.outputs['ip-17'] }}:3389`,
            `${{ needs.rdp-sessions.outputs['ip-18'] }}:3389`,
            `${{ needs.rdp-sessions.outputs['ip-19'] }}:3389`,
            `${{ needs.rdp-sessions.outputs['ip-20'] }}:3389`
          ];
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ðŸš€ 20x RDP BATCH #${{ github.run_number }} READY`,
            body: `**ðŸ‘¤ USER:** `RDP2025`
**ðŸ”‘ PASS:** `RDP2025@#123`

**ðŸ“± 20 RDP LIST:**
```
${ips.join('\
')}
```

**âš¡ 320GB RAM | 80 CORES | 6 HOURS**`
          });
