name: Windows RDP
on:
  workflow_dispatch:
  
jobs:
  rdp:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
      
    - name: Download ngrok
      run: |
        Invoke-WebRequest https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip -OutFile ngrok.zip
        Expand-Archive ngrok.zip
        .
grok.exe authtoken ${{ secrets.NGROK_TOKEN }}
        
    - name: Enable RDP
      run: |
        Set-ItemProperty -Path 'HKLM:SystemCurrentControlSetControlTerminal Server' -name "fDenyTSConnections" -value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        
    - name: Get public IP
      run: curl ifconfig.me > ip.txt
      
    - name: Start ngrok
      run: Start-Process -FilePath .
grok.exe -ArgumentList "tcp","3389","--remote-addr=0.tcp.ngrok.io:12345" -NoNewWindow
      
    - name: Display connection info
      run: |
        Get-Content ip.txt
        Write-Output "RDP: 0.tcp.ngrok.io:12345 User: Administrator Password: auto-generated in logs"
